"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,n=(e=require("regenerator-runtime"))&&"object"==typeof e&&"default"in e?e.default:e,t=require("@stacks/auth"),r=require("jsontokens"),o=require("@stacks/transactions"),i=require("@stacks/network"),a=require("@stacks/connect-ui");function s(e,n,t,r,o,i,a){try{var s=e[i](a),u=s.value}catch(e){return void t(e)}s.done?n(u):Promise.resolve(u).then(r,o)}function u(e){return function(){var n=this,t=arguments;return new Promise((function(r,o){var i=e.apply(n,t);function a(e){s(i,r,o,a,u,"next",e)}function u(e){s(i,r,o,a,u,"throw",e)}a(void 0)}))}}function c(){return(c=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}function p(e,n){if(null==e)return{};var t,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n.indexOf(t=i[r])>=0||(o[t]=e[t]);return o}function l(){return window.StacksProvider||window.BlockstackProvider}"undefined"!=typeof window&&(window.__CONNECT_VERSION__="5.5.0");var f,d,v=function(){var e=navigator.userAgent;return!!/android/i.test(e)||!!/iPad|iPhone|iPod/.test(e)||/windows phone/i.test(e)},h=function(e){if(!e){var n=new t.AppConfig(["store_write"],document.location.href);e=new t.UserSession({appConfig:n})}return e},y=function(e){var t=l();if(!t)throw new Error("Unable to authenticate without Stacks Wallet extension");var r=e.redirectTo,o=void 0===r?"/":r,i=e.manifestPath,a=e.finished,s=e.onFinish,c=e.onCancel,p=e.sendToSignIn,f=void 0!==p&&p,d=e.appDetails,v=h(e.userSession);v.isUserSignedIn()&&v.signUserOut();var y=v.generateAndStoreTransitKey(),w=v.makeAuthRequest(y,""+document.location.origin+o,""+document.location.origin+i,v.appConfig.scopes,void 0,void 0,{sendToSignIn:f,appDetails:d,connectVersion:"5.5.0"});t.authenticationRequest(w).then(function(){var e=u(n.mark((function e(t){var r;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.handlePendingSignIn(t);case 2:null==(r=s||a)||r({authResponse:t,userSession:v});case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()).catch((function(e){console.error("[Connect] Error during auth request",e),null==c||c()}))},w=function(){var e=u(n.mark((function e(t){return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=h(t)).isUserSignedIn()){e.next=3;break}return e.abrupt("return",t.loadUserData());case 3:if(!t.isSignInPending()){e.next=5;break}return e.abrupt("return",t.handlePendingSignIn());case 5:return e.abrupt("return",null);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}();(f=exports.TransactionTypes||(exports.TransactionTypes={})).ContractCall="contract_call",f.ContractDeploy="smart_contract",f.STXTransfer="token_transfer",(d=exports.ContractCallArgumentType||(exports.ContractCallArgumentType={})).BUFFER="buffer",d.UINT="uint",d.INT="int",d.PRINCIPAL="principal",d.BOOL="bool";var x=function(e){var n=e;if(!n){var r=new t.AppConfig(["store_write"],document.location.href);n=new t.UserSession({appConfig:r})}return n},k=function(e){var n=x(e).loadUserData().appPrivateKey;return{privateKey:n,publicKey:r.SECP256K1Client.derivePublicKey(n)}};function g(e){var n,t,r=e.stxAddress,i=e.userSession,a=e.network;if(r)return r;if(i&&a){var s=null==i||null==(n=i.loadUserData().profile)?void 0:n.stxAddress,u=((t={})[o.ChainID.Mainnet]="mainnet",t[o.ChainID.Testnet]="testnet",t);return null==s?void 0:s[u[a.chainId]]}}function C(e){var n=c({},e,{network:e.network||new i.StacksTestnet,userSession:x(e.userSession)});return c({stxAddress:g(n)},n)}var m=function(){var e=u(n.mark((function e(t,i){var a,s;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(a=t.postConditions)&&"string"!=typeof a[0]&&(a=a.map((function(e){return o.serializePostCondition(e).toString("hex")}))),s=new r.TokenSigner("ES256k",i),e.abrupt("return",s.signAsync(c({},t,{postConditions:a})));case 4:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),S=function(e){var n=e.token,t=e.options,r=l();if(!r)throw new Error("Stacks Wallet not installed.");r.transactionRequest(n).then((function(e){var n=t.finished||t.onFinish,r=Buffer.from(e.txRaw.replace(/^0x/,""),"hex"),i=o.deserializeTransaction(new o.BufferReader(r));if("sponsored"in t&&t.sponsored){var a=t.onFinish||t.finished;null==a||a(c({},e,{stacksTransaction:i}))}else null==n||n(c({},e,{stacksTransaction:i}))})).catch((function(e){console.error("[Connect] Error during transaction request",e),null==t.onCancel||t.onCancel()}))},T=function(){var e=u(n.mark((function e(t){var r,i,a,s,u,l,f,d,v;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.functionArgs,i=t.appDetails,a=t.userSession,s=p(t,["functionArgs","appDetails","userSession"]),u=k(a),l=u.privateKey,f=u.publicKey,d=r.map((function(e){return"string"==typeof e?e:o.serializeCV(e).toString("hex")})),v=c({},s,{functionArgs:d,txType:exports.TransactionTypes.ContractCall,publicKey:f}),i&&(v.appDetails=i),e.abrupt("return",m(v,l));case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),b=function(){var e=u(n.mark((function e(t){var r,o,i,a,s,u;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.appDetails,o=t.userSession,i=p(t,["appDetails","userSession"]),a=k(o),s=a.privateKey,u=c({},i,{publicKey:a.publicKey,txType:exports.TransactionTypes.ContractDeploy}),r&&(u.appDetails=r),e.abrupt("return",m(u,s));case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),P=function(){var e=u(n.mark((function e(t){var r,o,i,a,s,u,l,f;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.amount,o=t.appDetails,i=t.userSession,a=p(t,["amount","appDetails","userSession"]),s=k(i),u=s.privateKey,l=s.publicKey,f=c({},a,{amount:r.toString(10),publicKey:l,txType:exports.TransactionTypes.STXTransfer}),o&&(f.appDetails=o),e.abrupt("return",m(f,u));case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}();function D(e,n){return A.apply(this,arguments)}function A(){return(A=u(n.mark((function e(t,r){return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r(c({},C(t),t));case 2:return e.abrupt("return",S({token:e.sent,options:t}));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var I=function(e){if(l())y(e);else{a.defineCustomElements();var n=document.createElement("connect-modal");n.authOptions=e,document.body.appendChild(n),document.addEventListener("keydown",(function e(t){"Escape"===t.key&&(document.removeEventListener("keydown",e),n.remove())}))}};Object.keys(t).forEach((function(e){"default"!==e&&Object.defineProperty(exports,e,{enumerable:!0,get:function(){return t[e]}})})),exports.authenticate=y,exports.defaultAuthURL="https://app.blockstack.org",exports.getOrCreateUserSession=h,exports.getStacksProvider=l,exports.getUserData=w,exports.isMobile=v,exports.isStacksWalletInstalled=function(){return!!l()},exports.makeContractCallToken=T,exports.makeContractDeployToken=b,exports.makeSTXTransferToken=P,exports.openContractCall=function(e){return D(e,T)},exports.openContractDeploy=function(e){return D(e,b)},exports.openSTXTransfer=function(e){return D(e,P)},exports.shouldUsePopup=function(){return!v()},exports.showBlockstackConnect=function(e){return I(e)},exports.showConnect=I;
//# sourceMappingURL=connect.cjs.production.min.js.map
