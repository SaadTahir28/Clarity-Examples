{"version":3,"file":"auth.esm.js","sources":["../src/auth.ts"],"sourcesContent":["import { AppConfig, UserSession } from '@stacks/auth';\nimport type { AuthOptions } from './types';\n\nimport { getStacksProvider } from './utils';\n\nexport const defaultAuthURL = 'https://app.blockstack.org';\n\nconst version = __VERSION__;\n\nif (typeof window !== 'undefined') {\n  window.__CONNECT_VERSION__ = version;\n}\n\nexport const isMobile = () => {\n  const ua = navigator.userAgent;\n  if (/android/i.test(ua)) {\n    return true;\n  }\n  if (/iPad|iPhone|iPod/.test(ua)) {\n    return true;\n  }\n  return /windows phone/i.test(ua);\n};\n\n/**\n * mobile should not use a 'popup' type of window.\n */\nexport const shouldUsePopup = () => {\n  return !isMobile();\n};\n\nexport const getOrCreateUserSession = (userSession?: UserSession): UserSession => {\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n  return userSession;\n};\n\nexport const authenticate = (authOptions: AuthOptions) => {\n  const provider = getStacksProvider();\n  if (!provider) {\n    throw new Error('Unable to authenticate without Stacks Wallet extension');\n  }\n\n  const {\n    redirectTo = '/',\n    manifestPath,\n    finished,\n    onFinish,\n    onCancel,\n    sendToSignIn = false,\n    userSession: _userSession,\n    appDetails,\n  } = authOptions;\n  const userSession = getOrCreateUserSession(_userSession);\n  if (userSession.isUserSignedIn()) {\n    userSession.signUserOut();\n  }\n  const transitKey = userSession.generateAndStoreTransitKey();\n  const authRequest = userSession.makeAuthRequest(\n    transitKey,\n    `${document.location.origin}${redirectTo}`,\n    `${document.location.origin}${manifestPath}`,\n    userSession.appConfig.scopes,\n    undefined,\n    undefined,\n    {\n      sendToSignIn,\n      appDetails,\n      connectVersion: version,\n    }\n  );\n\n  void provider\n    .authenticationRequest(authRequest)\n    .then(async authResponse => {\n      await userSession.handlePendingSignIn(authResponse);\n      const success = onFinish || finished;\n      success?.({\n        authResponse,\n        userSession,\n      });\n    })\n    .catch(error => {\n      console.error('[Connect] Error during auth request', error);\n      onCancel?.();\n    });\n};\n\nexport const getUserData = async (userSession?: UserSession) => {\n  userSession = getOrCreateUserSession(userSession);\n  if (userSession.isUserSignedIn()) {\n    return userSession.loadUserData();\n  }\n  if (userSession.isSignInPending()) {\n    return userSession.handlePendingSignIn();\n  }\n  return null;\n};\n"],"names":["defaultAuthURL","version","__VERSION__","window","__CONNECT_VERSION__","isMobile","ua","navigator","userAgent","test","shouldUsePopup","getOrCreateUserSession","userSession","appConfig","AppConfig","document","location","href","UserSession","authenticate","authOptions","provider","getStacksProvider","Error","redirectTo","manifestPath","finished","onFinish","onCancel","sendToSignIn","_userSession","appDetails","isUserSignedIn","signUserOut","transitKey","generateAndStoreTransitKey","authRequest","makeAuthRequest","origin","scopes","connectVersion","authenticationRequest","then","authResponse","handlePendingSignIn","success","error","getUserData","loadUserData","isSignInPending"],"mappings":";;;;;IAKaA,iBAAiB;AAE9B,IAAMC,UAAUC,OAAhB;;AAEA,IAAI,OAAOC,MAAP,KAAkB,WAAtB,EAAmC;SAC1BC,sBAAsBH;;;IAGlBI,WAAW,SAAXA,QAAW,GAAM;MACtBC,KAAKC,UAAUC;;MACjB,WAAWC,IAAX,CAAgBH,EAAhB,GAAqB;WAChB;;;MAEL,mBAAmBG,IAAnB,CAAwBH,EAAxB,GAA6B;WACxB;;;SAEF,iBAAiBG,IAAjB,CAAsBH,EAAtB;;IAMII,iBAAiB,SAAjBA,cAAiB,GAAM;SAC3B,CAACL;;IAGGM,yBAAyB,SAAzBA,sBAAyB,CAACC,WAAD,EAA4C;MAC5E,CAACA,aAAa;QACVC,YAAY,IAAIC,SAAJ,CAAc,CAAC,aAAD,CAAd,EAA+BC,SAASC,QAAT,CAAkBC,IAAjD;kBACJ,IAAIC,WAAJ,CAAgB;AAAEL,MAAAA,WAAAA;AAAF,KAAhB;;;SAETD;;IAGIO,eAAe,SAAfA,YAAe,CAACC,WAAD,EAA8B;MAClDC,WAAWC;;MACb,CAACD,UAAU;UACP,IAAIE,KAAJ,CAAU,wDAAV;;;AAHgD,8BAepDH,WAfoD,CAOtDI,UAPsD;AAAA,MAOtDA,UAPsD,sCAOzC,GAPyC;AAAA,MAQtDC,YARsD,GAepDL,WAfoD,CAQtDK,YARsD;AAAA,MAStDC,QATsD,GAepDN,WAfoD,CAStDM,QATsD;AAAA,MAUtDC,QAVsD,GAepDP,WAfoD,CAUtDO,QAVsD;AAAA,MAWtDC,QAXsD,GAepDR,WAfoD,CAWtDQ,QAXsD;AAAA,8BAepDR,WAfoD,CAYtDS,YAZsD;AAAA,MAYtDA,YAZsD,sCAYvC,KAZuC;AAAA,MAazCC,YAbyC,GAepDV,WAfoD,CAatDR,WAbsD;AAAA,MActDmB,UAdsD,GAepDX,WAfoD,CActDW,UAdsD;MAgBlDnB,cAAcD,uBAAuBmB;;MACvClB,YAAYoB,cAAZ,IAA8B;gBACpBC;;;MAERC,aAAatB,YAAYuB,0BAAZ;MACbC,cAAcxB,YAAYyB,eAAZ,CAClBH,UADkB,OAEfnB,SAASC,QAAT,CAAkBsB,MAFH,GAEYd,UAFZ,OAGfT,SAASC,QAAT,CAAkBsB,MAHH,GAGYb,YAHZ,EAIlBb,YAAYC,SAAZ,CAAsB0B,MAJJ,EAKlB,MALkB,EAMlB,MANkB,EAOlB;AACEV,IAAAA,cAAAA,YADF;AAEEE,IAAAA,YAAAA,UAFF;AAGES,IAAAA,gBAAgBvC;AAHlB,GAPkB;OAcfoB,SACFoB,qBADE,CACoBL,WADpB,EAEFM,IAFE;AAAA,wEAEG,iBAAMC,YAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBACE/B,YAAYgC,mBAAZ,CAAgCD,YAAhC,CADF;;AAAA;AAEEE,cAAAA,OAFF,GAEYlB,YAAYD,QAFxB;iDAGM;AACRiB,gBAAAA,cAAAA,YADQ;AAER/B,gBAAAA,aAAAA;AAFQ;;AAHN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAFH;;AAAA;AAAA;AAAA;AAAA,gBAUI,eAAA,EAAS;YACNkC,MAAM,uCAAuCA;;GAXpD;;IAgBMC;oFAAc,kBAAOnC,WAAP;AAAA;AAAA;AAAA;AAAA;0BACXD,uBAAuBC;;AADZ,iBAErBA,YAAYoB,cAAZ,EAFqB;AAAA;AAAA;AAAA;;AAAA,8CAGhBpB,YAAYoC,YAAZ,EAHgB;;AAAA;AAAA,iBAKrBpC,YAAYqC,eAAZ,EALqB;AAAA;AAAA;AAAA;;AAAA,8CAMhBrC,YAAYgC,mBAAZ,EANgB;;AAAA;AAAA,8CAQlB,IARkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;kBAAdG;;;;;;;"}